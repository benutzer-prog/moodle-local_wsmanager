/**
 * Webservices actions.
 *
 * @module     local_wsmanager/webservices
 * @copyright  2023 Lilia Smirnova <lilia.pro@protonmail.com>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define(["jquery","core/ajax","core/modal_factory","core/modal_events","local_wsmanager/base"],(function(e,a,r,t,n){return{local_wsmanager_webservice_tokens_table_output:function(r){return a.call([{methodname:"local_wsmanager_webservice_tokens_table_output",args:{webserviceid:r}}])[0].then((function(a){e("#local_wsmanager_webservice_tokens_table_"+r).html(a)}))},local_wsmanager_functions_table_output:function(r){return a.call([{methodname:"local_wsmanager_webservice_functions_table_output",args:{webserviceid:r}}])[0].then((function(a){e("#local_wsmanager_webservice_functions_table_"+id).html(a)}))},init:function(n,s,o,c){var i=this,l=window.location.hash.substring(1);if(l&&"create_webservice_form"===l)e("#local_wsmanager_create_webservice_form").show(),e("#local_wsmanager_create_webservice_form_show").addClass("opened");e("body").on("click",".local_wsmanager_tab_link",(function(a){a.preventDefault();var r=e(this),t=r.data("webserviceid");return e(".local_wsmanager_tab_link").removeClass("active"),r.addClass("active"),e(".local_wsmanager_webservice_data_output").hide(),e("#local_wsmanager_webservice_data_output_"+t).show(),!1})).on("click","#local_wsmanager_create_webservice_form_show",(function(a){a.preventDefault();var r=e(this);return r.hasClass("opened")?(e("#local_wsmanager_create_webservice_form").hide(),r.removeClass("opened")):(e("#local_wsmanager_create_webservice_form").show(),r.addClass("opened")),!1})).on("submit","#local_wsmanager_create_webservice_form form",(function(r){r.preventDefault();var t=e(this),n={},s=t.serializeArray();return s&&(e.each(s,(function(e,a){if(a.name)switch(a.name){case"sesskey":n.sesskey=a.value;break;case"_qf__local_wsmanager_webservice_form":n._qf__local_wsmanager_webservice_form=parseInt(a.value);break;case"name":n.name=a.value;break;case"shortname":n.shortname=a.value;break;case"enabled":n.enabled=parseInt(a.value);break;case"restrictedusers":n.restrictedusers=parseInt(a.value);break;case"downloadfiles":n.downloadfiles=parseInt(a.value);break;case"uploadfiles":n.uploadfiles=parseInt(a.value);break;case"requiredcapability":n.requiredcapability=a.value}})),e.post(M.cfg.wwwroot+"/local/wsmanager/webservices.php",n,(function(r){r.success&&a.call([{methodname:"local_wsmanager_webservice_create",args:{name:n.name,shortname:n.shortname,enabled:n.enabled,restrictedusers:n.restrictedusers,downloadfiles:n.downloadfiles,uploadfiles:n.uploadfiles,requiredcapability:n.requiredcapability}}])[0].then((function(a){0===a.errors.length&&a.errors.webservice&&window.location.replace(e("#local_wsmanager_url").val())}))}),"json")),!1})).on("click",'#local_wsmanager_create_webservice_form [name="cancel"]',(function(a){return a.preventDefault(),e("#local_wsmanager_create_webservice_form").hide(),!1})).on("click",".local_wsmanager_webservice_token_create_form_button",(function(a){a.preventDefault();var r=e(this),t=r.data("webserviceid");return e("#local_wsmanager_webservice_token_create_form_wrapper_"+t).show(),r.hide(),!1})).on("submit",".local_wsmanager_webservice_token_create_form",(function(r){r.preventDefault();var t=e(this),n={valid_until:{}},s=t.serializeArray();return s&&(e.each(s,(function(a,r){if(r.name)switch(r.name){case"webserviceid":n.webserviceid=parseInt(r.value);break;case"sesskey":n.sesskey=r.value;break;case"_qf__local_wsmanager_token_form":n._qf__local_wsmanager_token_form=parseInt(r.value);break;case"user":n.user=parseInt(r.value);break;case"iprestriction":n.iprestriction=e.trim(r.value);break;case"validuntil[enabled]":n.validUntilEnabled=!0;break;case"validuntil[day]":n.valid_until.day=parseInt(r.value);break;case"validuntil[month]":n.valid_until.month=parseInt(r.value);break;case"validuntil[year]":n.valid_until.year=parseInt(r.value)}})),n.validUntilEnabled||(n.valid_until={}),e.post(M.cfg.wwwroot+"/local/wsmanager/webservices.php",n,(function(e){e.success&&a.call([{methodname:"local_wsmanager_webservice_token_create",args:{webserviceid:n.webserviceid,userid:n.user,iprestriction:n.iprestriction,valid_until:n.valid_until}}])[0].then((function(e){e.id&&i.local_wsmanager_webservice_tokens_table_output(n.webserviceid)}))}),"json")),!1})).on("click",'.local_wsmanager_webservice_token_create_form_wrapper [name="cancel"]',(function(a){a.preventDefault();var r=e(this).closest(".local_wsmanager_webservice_token_create_form_wrapper"),t=0;return r&&(t=r.data("webserviceid"),e("#local_wsmanager_webservice_token_create_form_button_"+t).show(),e("#local_wsmanager_webservice_token_create_form_wrapper_"+t).hide()),!1})).on("click",".local_wsmanager_webservice_token_delete",(function(n){n.preventDefault();var s=e(this),o=parseInt(s.data("webserviceid")),c=parseInt(s.data("tokenid")),l=s.data("token");return c&&r.create({type:r.types.SAVE_CANCEL,title:M.str.webservice.deletetoken,body:M.str.webservice.deletetoken+" <strong>"+l+"</strong><br />"+M.str.moodle.areyousure}).then((function(e){e.setButtonText("save",M.str.moodle.delete),e.getRoot().on(t.save,(function(r){r.preventDefault(),a.call([{methodname:"local_wsmanager_webservice_token_delete",args:{tokenid:c}}])[0].then((function(e){i.local_wsmanager_webservice_tokens_table_output(o)})),e.hide()})),e.getRoot().on(t.cancel,(function(){e.hide()})),e.show()})),!1})).on("click",".local_wsmanager_webservice_functions_add_form_button",(function(a){a.preventDefault();var r=e(this),t=r.data("webserviceid");return e("#local_wsmanager_webservice_functions_add_form_wrapper_"+t).show(),r.hide(),!1})).on("submit",".local_wsmanager_webservice_functions_add_form",(function(r){r.preventDefault();var t=e(this),n=[],s=t.data("webserviceid"),o=t.serializeArray();return o&&(e.each(o,(function(e,a){if(a.name&&a.name==="fids_"+s+"[]")n.push(parseInt(a.value))})),n.length&&e.each(n,(function(e,r){a.call([{methodname:"local_wsmanager_webservice_function_add",args:{functionid:r,webserviceid:s}}])[0].then((function(e){i.local_wsmanager_functions_table_output(s)}))}))),!1})).on("click",'.local_wsmanager_webservice_functions_add_form_wrapper [name="cancel"]',(function(a){a.preventDefault();var r=e(this).closest(".local_wsmanager_webservice_functions_add_form_wrapper"),t=0;return r&&(t=r.data("webserviceid"),e("#local_wsmanager_webservice_functions_add_form_button_"+t).show(),e("#local_wsmanager_webservice_functions_add_form_wrapper_"+t).hide()),!1})).on("click",".local_wsmanager_webservice_function_delete",(function(n){n.preventDefault();var s=e(this),o=parseInt(s.data("webserviceid")),c=parseInt(s.data("functionid")),l=s.data("functionname");return o&&c&&l&&r.create({type:r.types.SAVE_CANCEL,title:M.str.webservice.removefunction,body:M.str.webservice.removefunction+" <strong>"+l+"</strong><br />"+M.str.moodle.areyousure}).then((function(e){e.setButtonText("save",M.str.moodle.remove),e.getRoot().on(t.save,(function(r){r.preventDefault(),a.call([{methodname:"local_wsmanager_webservice_function_delete",args:{functionid:c,webserviceid:o}}])[0].then((function(e){i.local_wsmanager_functions_table_output(o)})),e.hide()})),e.getRoot().on(t.cancel,(function(){e.hide()})),e.show()})),!1})).on("click",".local_wsmanager_webservice_delete",(function(n){n.preventDefault();var s=e(this),o=parseInt(s.data("webserviceid")),c=s.data("name");return o&&r.create({type:r.types.SAVE_CANCEL,title:M.str.webservice.deleteaservice,body:M.str.webservice.deleteaservice+" "+c+"<br />"+M.str.moodle.areyousure}).then((function(r){r.setButtonText("save",M.str.moodle.delete),r.getRoot().on(t.save,(function(t){t.preventDefault(),a.call([{methodname:"local_wsmanager_webservice_delete",args:{webserviceid:o}}])[0].then((function(a){window.location.replace(e("#local_wsmanager_url").val())})),r.hide()})),r.getRoot().on(t.cancel,(function(){r.hide()})),r.show()})),!1})).on("click",".local_wsmanager_webservice_user_delete",(function(n){n.preventDefault();var s=e(this),o=parseInt(s.data("webserviceid")),c=s.data("userid");return o&&c&&r.create({type:r.types.SAVE_CANCEL,title:M.str.admin.deleteuser,body:M.str.moodle.areyousure}).then((function(r){r.setButtonText("save",M.str.moodle.delete),r.getRoot().on(t.save,(function(t){t.preventDefault(),a.call([{methodname:"local_wsmanager_webservice_user_delete",args:{webserviceid:o,userid:c}}])[0].then((function(a){var r=e(".local_wsmanager_webservice_user_row_"+o).length;a&&(e("#local_wsmanager_webservice_user_row_"+o+"_"+c).remove(),1===r&&e("#local_wsmanager_webservice_users_table_"+o).remove())})),r.hide()})),r.getRoot().on(t.cancel,(function(){r.hide()})),r.show()})),!1}))}}}));