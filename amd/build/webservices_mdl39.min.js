define("local_wsmanager/webservices_mdl39",["exports","core/ajax","core/modal_factory","core/modal_events","jquery"],(function(_exports,_ajax,_modal_factory,_modal_events,_jquery){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Webservices actions for Moodle >=3.9
   *
   * @module     local_wsmanager/webservices_mdl39
   * @copyright  2024 Lilia Smirnova <lilia.pro@protonmail.com>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_modal_factory=_interopRequireDefault(_modal_factory),_modal_events=_interopRequireDefault(_modal_events),_jquery=_interopRequireDefault(_jquery);const local_wsmanager_webservice_tokens_table_output=webserviceid=>{(0,_ajax.call)([{methodname:"local_wsmanager_webservice_tokens_table_output",args:{webserviceid:webserviceid}}])[0].then((function(res){(0,_jquery.default)("#local_wsmanager_webservice_tokens_table_"+webserviceid).html(res)}))},local_wsmanager_functions_table_output=webserviceid=>{(0,_ajax.call)([{methodname:"local_wsmanager_webservice_functions_table_output",args:{webserviceid:webserviceid}}])[0].then((function(res){(0,_jquery.default)("#local_wsmanager_webservice_functions_table_"+webserviceid).html(res)}))};_exports.init=(sep1,sep2,sep3,sep4)=>{var anchor=window.location.hash.substring(1);if(anchor&&"create_webservice_form"===anchor)(0,_jquery.default)("#local_wsmanager_create_webservice_form").show(),(0,_jquery.default)("#local_wsmanager_create_webservice_form_show").addClass("opened");(0,_jquery.default)("body").on("click",".local_wsmanager_tab_link",(function(event){event.preventDefault();var $this=(0,_jquery.default)(this),webserviceid=$this.data("webserviceid");return(0,_jquery.default)(".local_wsmanager_tab_link").removeClass("active"),$this.addClass("active"),(0,_jquery.default)(".local_wsmanager_webservice_data_output").hide(),(0,_jquery.default)("#local_wsmanager_webservice_data_output_"+webserviceid).show(),!1})).on("click","#local_wsmanager_create_webservice_form_show",(function(event){event.preventDefault();var $this=(0,_jquery.default)(this);return $this.hasClass("opened")?((0,_jquery.default)("#local_wsmanager_create_webservice_form").hide(),$this.removeClass("opened")):((0,_jquery.default)("#local_wsmanager_create_webservice_form").show(),$this.addClass("opened")),!1})).on("submit","#local_wsmanager_create_webservice_form form",(function(event){event.preventDefault();var $this=(0,_jquery.default)(this),data={},formData=$this.serializeArray();return formData&&(_jquery.default.each(formData,(function(i,item){if(item.name)switch(item.name){case"sesskey":data.sesskey=item.value;break;case"_qf__local_wsmanager_webservice_form":data._qf__local_wsmanager_webservice_form=parseInt(item.value);break;case"name":data.name=item.value;break;case"shortname":data.shortname=item.value;break;case"enabled":data.enabled=parseInt(item.value);break;case"restrictedusers":data.restrictedusers=parseInt(item.value);break;case"downloadfiles":data.downloadfiles=parseInt(item.value);break;case"uploadfiles":data.uploadfiles=parseInt(item.value);break;case"requiredcapability":data.requiredcapability=item.value}})),_jquery.default.post(M.cfg.wwwroot+"/local/wsmanager/webservices.php",data,(function(response){response.success&&(0,_ajax.call)([{methodname:"local_wsmanager_webservice_create",args:{name:data.name,shortname:data.shortname,enabled:data.enabled,restrictedusers:data.restrictedusers,downloadfiles:data.downloadfiles,uploadfiles:data.uploadfiles,requiredcapability:data.requiredcapability}}])[0].then((function(res){0===res.errors.length&&res.errors.webservice&&window.location.replace((0,_jquery.default)("#local_wsmanager_url").val())}))}),"json")),!1})).on("click",'#local_wsmanager_create_webservice_form [name="cancel"]',(function(event){return event.preventDefault(),(0,_jquery.default)("#local_wsmanager_create_webservice_form").hide(),!1})).on("click",".local_wsmanager_webservice_token_create_form_button",(function(event){event.preventDefault();var $this=(0,_jquery.default)(this),webserviceid=$this.data("webserviceid");return(0,_jquery.default)("#local_wsmanager_webservice_token_create_form_wrapper_"+webserviceid).show(),$this.hide(),!1})).on("submit",".local_wsmanager_webservice_token_create_form",(function(event){event.preventDefault();var $this=(0,_jquery.default)(this),data={valid_until:{}},formData=$this.serializeArray();return formData&&(_jquery.default.each(formData,(function(i,item){if(item.name)switch(item.name){case"webserviceid":data.webserviceid=parseInt(item.value);break;case"sesskey":data.sesskey=item.value;break;case"_qf__local_wsmanager_token_form":data._qf__local_wsmanager_token_form=parseInt(item.value);break;case"user":data.user=parseInt(item.value);break;case"iprestriction":data.iprestriction=_jquery.default.trim(item.value);break;case"validuntil[enabled]":data.validUntilEnabled=!0;break;case"validuntil[day]":data.valid_until.day=parseInt(item.value);break;case"validuntil[month]":data.valid_until.month=parseInt(item.value);break;case"validuntil[year]":data.valid_until.year=parseInt(item.value)}})),data.validUntilEnabled||(data.valid_until={}),_jquery.default.post(M.cfg.wwwroot+"/local/wsmanager/webservices.php",data,(function(response){response.success&&(0,_ajax.call)([{methodname:"local_wsmanager_webservice_token_create",args:{webserviceid:data.webserviceid,userid:data.user,iprestriction:data.iprestriction,valid_until:data.valid_until}}])[0].then((function(res){res.id&&local_wsmanager_webservice_tokens_table_output(data.webserviceid)}))}),"json")),!1})).on("click",'.local_wsmanager_webservice_token_create_form_wrapper [name="cancel"]',(function(event){event.preventDefault();var parent=(0,_jquery.default)(this).closest(".local_wsmanager_webservice_token_create_form_wrapper"),webserviceid=0;return parent&&(webserviceid=parent.data("webserviceid"),(0,_jquery.default)("#local_wsmanager_webservice_token_create_form_button_"+webserviceid).show(),(0,_jquery.default)("#local_wsmanager_webservice_token_create_form_wrapper_"+webserviceid).hide()),!1})).on("click",".local_wsmanager_webservice_token_delete",(function(event){event.preventDefault();var $this=(0,_jquery.default)(this),webserviceid=parseInt($this.data("webserviceid")),tokenid=parseInt($this.data("tokenid")),token=$this.data("token");return tokenid&&_modal_factory.default.create({type:_modal_factory.default.types.SAVE_CANCEL,title:M.str.webservice.deletetoken,body:M.str.webservice.deletetoken+" <strong>"+token+"</strong><br />"+M.str.moodle.areyousure}).then((function(modal){modal.setButtonText("save",M.str.moodle.delete),modal.getRoot().on(_modal_events.default.save,(function(e){e.preventDefault(),(0,_ajax.call)([{methodname:"local_wsmanager_webservice_token_delete",args:{tokenid:tokenid}}])[0].then((function(response){local_wsmanager_webservice_tokens_table_output(webserviceid)})),modal.hide()})),modal.getRoot().on(_modal_events.default.cancel,(function(){modal.hide()})),modal.show()})),!1})).on("click",".local_wsmanager_webservice_functions_add_form_button",(function(event){event.preventDefault();var $this=(0,_jquery.default)(this),webserviceid=$this.data("webserviceid");return(0,_jquery.default)("#local_wsmanager_webservice_functions_add_form_wrapper_"+webserviceid).show(),$this.hide(),!1})).on("submit",".local_wsmanager_webservice_functions_add_form",(function(event){event.preventDefault();var $this=(0,_jquery.default)(this),fids=[],webserviceid=$this.data("webserviceid"),formData=$this.serializeArray();return formData&&(_jquery.default.each(formData,(function(i,item){if(item.name&&item.name==="fids_"+webserviceid+"[]")fids.push(parseInt(item.value))})),fids.length&&_jquery.default.each(fids,(function(i,fid){(0,_ajax.call)([{methodname:"local_wsmanager_webservice_function_add",args:{functionid:fid,webserviceid:webserviceid}}])[0].then((function(response){local_wsmanager_functions_table_output(webserviceid)}))}))),!1})).on("click",'.local_wsmanager_webservice_functions_add_form_wrapper [name="cancel"]',(function(event){event.preventDefault();var parent=(0,_jquery.default)(this).closest(".local_wsmanager_webservice_functions_add_form_wrapper"),webserviceid=0;return parent&&(webserviceid=parent.data("webserviceid"),(0,_jquery.default)("#local_wsmanager_webservice_functions_add_form_button_"+webserviceid).show(),(0,_jquery.default)("#local_wsmanager_webservice_functions_add_form_wrapper_"+webserviceid).hide()),!1})).on("click",".local_wsmanager_webservice_function_delete",(function(event){event.preventDefault();var $this=(0,_jquery.default)(this),webserviceid=parseInt($this.data("webserviceid")),functionid=parseInt($this.data("functionid")),functionname=$this.data("functionname");return webserviceid&&functionid&&functionname&&_modal_factory.default.create({type:_modal_factory.default.types.SAVE_CANCEL,title:M.str.webservice.removefunction,body:M.str.webservice.removefunction+" <strong>"+functionname+"</strong><br />"+M.str.moodle.areyousure}).then((function(modal){let root=modal.getRoot();modal.setButtonText("save",M.str.moodle.remove),root.on(_modal_events.default.save,(function(e){e.preventDefault(),(0,_ajax.call)([{methodname:"local_wsmanager_webservice_function_delete",args:{functionid:functionid,webserviceid:webserviceid}}])[0].then((function(response){local_wsmanager_functions_table_output(webserviceid)})),modal.hide()})),root.on(_modal_events.default.cancel,(function(){modal.hide()})),modal.show()})),!1})).on("click",".local_wsmanager_webservice_delete",(function(event){event.preventDefault();var $this=(0,_jquery.default)(this),webserviceid=parseInt($this.data("webserviceid")),name=$this.data("name");return webserviceid&&_modal_factory.default.create({type:_modal_factory.default.types.SAVE_CANCEL,title:M.str.webservice.deleteaservice,body:M.str.webservice.deleteaservice+" "+name+"<br />"+M.str.moodle.areyousure}).then((function(modal){let root=modal.getRoot();modal.setButtonText("save",M.str.moodle.delete),root.on(_modal_events.default.save,(function(e){e.preventDefault(),(0,_ajax.call)([{methodname:"local_wsmanager_webservice_delete",args:{webserviceid:webserviceid}}])[0].then((function(response){window.location.replace((0,_jquery.default)("#local_wsmanager_url").val())})),modal.hide()})),root.on(_modal_events.default.cancel,(function(){modal.hide()})),modal.show()})),!1})).on("click",".local_wsmanager_webservice_user_delete",(function(event){event.preventDefault();var $this=(0,_jquery.default)(this),webserviceid=parseInt($this.data("webserviceid")),userid=$this.data("userid");return webserviceid&&userid&&_modal_factory.default.create({type:_modal_factory.default.types.SAVE_CANCEL,title:M.str.admin.deleteuser,body:M.str.moodle.areyousure}).then((function(modal){let root=modal.getRoot();modal.setButtonText("save",M.str.moodle.delete),root.on(_modal_events.default.save,(function(e){e.preventDefault(),(0,_ajax.call)([{methodname:"local_wsmanager_webservice_user_delete",args:{webserviceid:webserviceid,userid:userid}}])[0].then((function(response){var cnt=(0,_jquery.default)(".local_wsmanager_webservice_user_row_"+webserviceid).length;response&&((0,_jquery.default)("#local_wsmanager_webservice_user_row_"+webserviceid+"_"+userid).remove(),1===cnt&&(0,_jquery.default)("#local_wsmanager_webservice_users_table_"+webserviceid).remove())})),modal.hide()})),root.on(_modal_events.default.cancel,(function(){modal.hide()})),modal.show()})),!1}))}}));

//# sourceMappingURL=webservices_mdl39.min.js.map