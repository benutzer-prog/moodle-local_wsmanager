/**
 * Base actions.
 *
 * @module     local_wsmanager/base
 * @copyright  2023 Lilia Smirnova <lilia.pro@protonmail.com>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define(["jquery","core/ajax","core/modal_factory","core/modal_events"],(function(e,a,n,t){return{local_wsmanager_webservice_nav_title:function(n){a.call([{methodname:"local_wsmanager_webservice_nav_title",args:{webserviceid:n}}])[0].then((function(a){e("#local_wsmanager_tab_link_webservice_"+n).html(a)}))},local_wsmanager_users_table_output:function(n){return a.call([{methodname:"local_wsmanager_webservice_users_table_output",args:{webserviceid:n}}])[0].then((function(a){e("#local_wsmanager_webservice_users_table_"+n).html(a)}))},local_wsmanager_webservice_functions_get_params:function(a,n,t,_,l,r){var o="";return e('[id*="local_wsmanager_ws_fn_param_'+a+"_"+n+'"]').each((function(){var _=e(this),l=_.attr("id").replace("local_wsmanager_ws_fn_param_"+a+"_"+n,"").split("_");o+=a+t+n+t+l[1]+t+_.val()+r})),o},local_wsmanager_request_info:function(n,t,_,l,r,o,s){l||(l=e("#local_wsmanager_external_function_handle_method_"+n+"_"+t+" select").val()),r||(r=e("#local_wsmanager_external_function_handle_protocol_"+n+"_"+t+" select").val()),o||(o=e("#local_wsmanager_external_function_handle_restformat_"+n+"_"+t+" select").val()),s||(s=e("#local_wsmanager_external_function_handle_token_"+n+"_"+t+" select option:selected").text()),a.call([{methodname:"local_wsmanager_request_info",args:{webserviceid:n,functionname:t,params:_,method:l,protocol:r,restformat:o,token:s}}])[0].then((function(a){e("#local_wsmanager_request_info_"+n+"_"+t).html(a)}))},local_wsmanager_external_function_handle_output:function(e,n){return a.call([{methodname:"local_wsmanager_external_function_handle_output",args:{functionname:e,webserviceid:n}}])[0].then((function(e){return e}))},init:function(_,l,r,o){var s=this;e("body").on("change",'[data-switch="webservice"]',(function(_){var l=e(this),r=parseInt(l.data("webserviceid")),o=l.data("instance"),c=l.data("name");return l.is(":checked")?a.call([{methodname:"local_wsmanager_webservice_state_switch",args:{webserviceid:r,instance:o}}])[0].then((function(a){switch(o){case"restrictedusers":s.local_wsmanager_users_table_output(r);break;case"enabled":s.local_wsmanager_webservice_nav_title(r),e("#local_wsmanager_webservice_row_"+r).removeClass("local_wsmanager_webservice_row_danger"),e("#local_wsmanager_webservice_name_"+r).attr("disabled",!1)}})):n.create({type:n.types.SAVE_CANCEL,title:M.str.moodle.disable,body:M.str.moodle.disable+"<strong>"+c+"</strong><br>"+M.str.moodle.areyousure}).then((function(n){n.setButtonText("save",M.str.moodle.disable),n.getRoot().on(t.save,(function(t){t.preventDefault(),a.call([{methodname:"local_wsmanager_webservice_state_switch",args:{webserviceid:r,instance:o}}])[0].then((function(a){switch(o){case"restrictedusers":s.local_wsmanager_users_table_output(r);break;case"enabled":s.local_wsmanager_webservice_nav_title(r),e("#local_wsmanager_webservice_row_"+r).addClass("local_wsmanager_webservice_row_danger"),e("#local_wsmanager_webservice_name_"+r).attr("disabled",!0)}})),n.hide()})),n.getRoot().on(t.cancel,(function(){l.prop("checked",!0),n.hide()})),n.show()})),!1})).on("click",".local_wsmanager_external_function_handle_wrapper",(function(a){var t=e(this),_=parseInt(t.data("webserviceid")),l=t.data("functionname");return a.preventDefault(),n.create({type:n.types.DEFAULT,large:!0,title:M.str.local_wsmanager.test,body:s.local_wsmanager_external_function_handle_output(l,_)}).then((function(e){e.show()})),!1})).on("change",".local_wsmanager_external_function_handle_select select",(function(a){var n=e(this),t=n.closest(".local_wsmanager_external_function_handle_select"),c=parseInt(t.data("webserviceid")),i=t.data("functionname"),m=s.local_wsmanager_webservice_functions_get_params(c,i,_,l,r,o),u=e("#local_wsmanager_external_function_handle_method_"+c+"_"+i+" select").val(),w=e("#local_wsmanager_external_function_handle_protocol_"+c+"_"+i+" select").val(),d=e("#local_wsmanager_external_function_handle_restformat_"+c+"_"+i+" select").val(),f=e("#local_wsmanager_external_function_handle_token_"+c+"_"+i+" select option:selected").text();if("protocol"===t.data("instance"))"rest"!=n.val()?e("#local_wsmanager_external_function_handle_restformat_row_"+c+"_"+i).hide():e("#local_wsmanager_external_function_handle_restformat_row_"+c+"_"+i).show();return s.local_wsmanager_request_info(c,i,m,u,w,d,f)})).on("blur",".local_wsmanager_webservice_function_param_value input,.local_wsmanager_webservice_function_param_value textarea",(function(a){a.preventDefault();var n=e(this).closest(".local_wsmanager_webservice_function_param_value"),t=parseInt(n.data("webserviceid")),c=n.data("functionname"),i=s.local_wsmanager_webservice_functions_get_params(t,c,_,l,r,o),m=e("#local_wsmanager_external_function_handle_method_"+t+"_"+c+" select").val(),u=e("#local_wsmanager_external_function_handle_protocol_"+t+"_"+c+" select").val(),w=e("#local_wsmanager_external_function_handle_restformat_"+t+"_"+c+" select").val(),d=e("#local_wsmanager_external_function_handle_token_"+t+"_"+c+" select option:selected").text();return s.local_wsmanager_request_info(t,c,i,m,u,w,d)})).on("click",".local_wsmanager_external_function_handle",(function(c){c.preventDefault();var i=e(this),m=parseInt(i.data("webserviceid")),u=i.data("functionname"),w=e("#local_wsmanager_external_function_handle_token_"+m+"_"+u+" select option:selected").text(),d=s.local_wsmanager_webservice_functions_get_params(m,u,_,l,r,o),f=e("#local_wsmanager_external_function_handle_method_"+m+"_"+u+" select").val(),g=e("#local_wsmanager_external_function_handle_protocol_"+m+"_"+u+" select").val(),h=e("#local_wsmanager_external_function_handle_restformat_"+m+"_"+u+" select").val();return n.create({type:n.types.SAVE_CANCEL,title:M.str.webservice.execute,body:M.str.webservice.execute+" <strong>"+u+"</strong><br />"+M.str.moodle.areyousure}).then((function(n){n.setButtonText("save",M.str.moodle.yes),n.getRoot().on(t.save,(function(t){t.preventDefault(),a.call([{methodname:"local_wsmanager_external_function_handle",args:{webserviceid:m,functionname:u,token:w,params:d,method:f,moodlewsprotocol:g,moodlewsrestformat:h}}])[0].then((function(a){e("#local_wsmanager_external_function_handle_response_content_"+m+"_"+u).html(a),e("#local_wsmanager_external_function_handle_response_"+m+"_"+u).show()})),n.hide()})),n.getRoot().on(t.cancel,(function(){n.hide()})),n.show()})),!1})).on("click",".local_wsmanager_webservice_name_update",(function(_){_.preventDefault();var l=e(this),r=parseInt(l.data("webserviceid")),o=e("#local_wsmanager_webservice_name_"+r).val();return a.call([{methodname:"local_wsmanager_webservice_rename",args:{webserviceid:r,name:o}}])[0].then((function(a){n.create({type:n.types.DEFAULT,title:M.str.moodle.summary,body:a?M.str.moodle.success:M.str.moodle.error}).then((function(e){e.getRoot().on(t.cancel,(function(){e.hide()})),e.show()})),a&&e("#local_wsmanager_tab_link_webservice_"+r).html(o)})),!1}))}}}));